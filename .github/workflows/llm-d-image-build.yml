name: llm-d image build

on:
  release:
    types: [published]
  pull_request:
    branches: [ main ]

# cancel any prior runs for this workflow and this PR (or branch)
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  attestations: write
  id-token: write  

env:
  RELEASE_VERSION: ${{ github.event.release.tag_name || 'latest' }}

jobs:
  build_and_push:
    name: build and push
    runs-on: ubuntu-latest
    strategy:
      matrix:
        gpu:
          - cuda
    steps:
      - uses: actions/checkout@v6

      - name: Aggressive disk space cleanup
        run: ./.github/scripts/free-up-disk-space.sh

      - name: Verify release version
        run: echo "RELEASE_VERSION=$RELEASE_VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # We only need to log in if we are going to push
      - name: Login to Container Registry
        uses: docker/login-action@v3
        if: ${{ env.RELEASE_VERSION != 'latest' && !github.event.release.prerelease }}
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build the Container Image for ${{ matrix.gpu }}
        uses: docker/build-push-action@v6
        with:
          push: ${{ env.RELEASE_VERSION != 'latest' && !github.event.release.prerelease }}
          cache-from: type=gha                              # Use github action mechanisms to cache layers
          cache-to: type=gha,mode=max                       # Use github action mechanisms to cache layers
          file: docker/vllm/llm-d/Containerfile.${{ matrix.gpu }}
          tags: ghcr.io/ibm/spnl-llm-d-${{ matrix.gpu }}:${{ env.RELEASE_VERSION }},ghcr.io/ibm/spnl-llm-d-${{ matrix.gpu }}:latest
          build-args: |
            SPNL_VERSION=${{ env.RELEASE_VERSION }}
